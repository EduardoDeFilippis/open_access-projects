# 0 - Preparazione dell'ambiente di lavoro
```{r, echo=TRUE}
options(repos = c(CRAN = "https://cran.rstudio.com/")) # Per creazione del documento con knit
install.packages("dplyr") # Per manipolazioni sui dati e creazione di grafici
install.packages("ggplot2") # Per creazione di grafici
install.packages("moments") # Per calcolo di asimmetria e curtosi
install.packages("gridExtra") # Per personalizzazione della finestra di output
library(dplyr)
library(ggplot2)
library(moments)
library(gridExtra)
```

# 1 - Preparazione dei dati
```{r, echo=TRUE}
url<-"https://raw.githubusercontent.com/ProfAI/statistica-descrittiva-per-datascience/refs/heads/main/progetto%20finale/Real%20Estate%20Texas.csv" # Link dataset in repository github
dati <- read.csv(url, sep=",") # Import dei dati
head(dati,10) # Visualizzazione prime 10 osservazioni
attach(dati) # Estrazione colonne
```

# 2 - Tipo di variabili

```{r, echo=TRUE}
str(dati) # Struttura dataset
```
```{r, echo=TRUE}
print(paste("Esito controllo valori mancanti: ",any(is.na(dati)))) # Controllo presenza na
```

# 3 -Indici di posizione, variabilità e forma

### 3.1 - Indici di posizione

```{r, echo=TRUE}
# Funzione per calcolare la moda
calcola_moda <- function(x) { 
  freq <- table(x)
  moda <- as.numeric(names(freq)[freq == max(freq)])
  return(moda)
}
```
```{r, echo=TRUE}
# Costruzione distribuzione di frequenze per city, year e month
# city
freq_ass <- table(city)
freq_rel <- table(city)/length(city) # Tabella distribuzione frequenze relative
distr_freq_city<-data.frame(cbind(freq_ass,freq_rel)) # Concatenazione e costruzione dataframe
colnames(distr_freq_city) <- c("Frequenza assoluta", "Frequenza relativa")
distr_freq_city
```
```{r, echo=TRUE}
# year
freq_ass <- table(year) 
freq_rel <- table(year)/length(year)
distr_freq_year<-data.frame(cbind(freq_ass,freq_rel))
colnames(distr_freq_year) <- c("Frequenza assoluta", "Frequenza relativa")
distr_freq_year
```
```{r, echo=TRUE}
# month
freq_ass <- table(month) 
freq_rel <- round(table(month)/length(month),3)
distr_freq_month<-data.frame(cbind(freq_ass,freq_rel))
colnames(distr_freq_month) <- c("Frequenza assoluta", "Frequenza relativa")
distr_freq_month
```

```{r, echo=TRUE}
# Creazione dataframe con indici di posizione
# Per le variabili qualitative ha senso calcolare alcuni indicatori solo per year che è ordinale

df_statistiche <- data.frame(
  Variabile = c("city","year", "month", "sales", "volume", "median_price", "listings", "months_inventory"),
  Moda = c( 
    NA, NA, NA, NA, NA, NA, NA, calcola_moda(months_inventory) # non calcolo moda per caratteri continui con molte modalità
  ),
  Media = c(
    NA, mean(year), NA, mean(sales), mean(volume), mean(median_price), mean(listings), mean(months_inventory) # calcolo media anche per year dato che è ordinale
  ),
  Minimo = c(
    NA, min(year), NA, min(sales), min(volume), min(median_price), min(listings), min(months_inventory)
  ),
  Massimo = c(
    NA, max(year), NA, max(sales), max(volume), max(median_price), max(listings), max(months_inventory)
  ),
  Q10 = c(
    NA, quantile(year, 0.1), NA, quantile(sales, 0.1), quantile(volume, 0.1),
    quantile(median_price, 0.1), quantile(listings, 0.1), quantile(months_inventory, 0.1)
  ),
  Q25 = c(
    NA, quantile(year, 0.25), NA, quantile(sales, 0.25), quantile(volume, 0.25), 
    quantile(median_price, 0.25), quantile(listings, 0.25), quantile(months_inventory, 0.25)
  ),
  Mediana = c(
    NA, quantile(year, 0.5), NA, quantile(sales, 0.5), quantile(volume, 0.5),
    quantile(median_price, 0.5), quantile(listings, 0.5), quantile(months_inventory, 0.5)
  ),
  Q75 = c(
    NA, quantile(year, 0.75), NA, quantile(sales, 0.75), quantile(volume, 0.75),
    quantile(median_price, 0.75), quantile(listings, 0.75), quantile(months_inventory, 0.75)
  ),
  Q90 = c(
    NA, quantile(year, 0.9), NA, quantile(sales, 0.9), quantile(volume, 0.9),
    quantile(median_price, 0.9), quantile(listings, 0.9), quantile(months_inventory, 0.9)
  )
)

# arrotondo tutti i valori del dataframe tranne prima colonna e poi la riaggiungo per la visualizzazione
print(cbind(df_statistiche[1],(round(df_statistiche[-1],3)))) 
```

### 3.2 - Indici di variabilità

```{r, echo=TRUE}
# Funzione per il calcolo del coefficiente di variazione
CV <-function(x){ 
  return( sd(x)/mean(x) )
}

# Funzione per il calcolo dell'indice di Gini
gini.index <- function(x){ 
  ni = table(x)
  fi = ni/length(x)
  fi2 = fi^2
  J = length(table(x))
  gini = 1-sum(fi2)
  gini.norm = gini/((J-1)/J)
  return(gini.norm)
}

# Calcolo separato degli indicatori e aggregazione in dataframe
range_values <- c(
  NA,
  range(year)[2] - range(year)[1],
  NA,
  range(sales)[2] - range(sales)[1],
  round(range(volume)[2] - range(volume)[1],3),
  range(median_price)[2] - range(median_price)[1],
  range(listings)[2] - range(listings)[1],
  range(months_inventory)[2] - range(months_inventory)[1]
)

IQR_values <- c(
  NA,
  IQR(year),
  NA,
  IQR(sales),
  round(IQR(volume),3),
  IQR(median_price),
  IQR(listings),
  IQR(months_inventory)
)

var_values <- c(
  NA,
  NA, # per year ha senso solo il range interquartile e non la varianza
  NA,
  format(var(sales),scientific=FALSE),
  format(var(volume),scientific=FALSE),
  format(var(median_price),scientific=FALSE),
  format(var(listings),scientific=FALSE),
  format(var(months_inventory),scientific=FALSE)
)

sd_values <- c(
  NA,
  NA,
  NA,
  round(sd(sales),3),
  round(sd(volume),3),
  round(sd(median_price),3),
  round(sd(listings),3),
  round(sd(months_inventory),3)
)

CV_values <- c(
  NA,
  NA,
  NA,
  round(CV(sales),3),
  round(CV(volume),3),
  round(CV(median_price),3),
  round(CV(listings),3),
  round(CV(months_inventory),3)
)

# È ovvio che l'indice di Gini per city, year e month è sicuramente 1 dato che assume tutte le modalità e sono equamente distribuite. 
# Per tutte le variabili quantitative l'indice assumerebbe valori vicinissimi a 1 proprio perchè sono variabili continue, dunque sarebbe più informativo e significativo se si calcolasse su una suddivisione in classi. 
gini_values <- c( 
  gini.index(city), 
  gini.index(year),
  gini.index(month),
  NA,
  NA,
  NA,
  NA,
  NA
)

# Creazione del dataframe
df <- data.frame(
  Variabile = c("city","year", "month", "sales", "volume", "median_price", "listings", "months_inventory"),
  Range = range_values,
  IQR = IQR_values,
  Varianza = var_values,
  Deviazione_Std = sd_values,
  CV = CV_values,
  Gini = gini_values
)

print(df)
```

### 3.3 - Indici di forma

```{r, echo=TRUE}
# Calcolo asimmetria (skewness) e curtosi (kurtosis - 3) per ciascuna variabile. Per city, year e month non ha senso
skewness_values <- c(
  NA,
  NA,
  NA,
  skewness(sales),
  skewness(volume),
  skewness(median_price),
  skewness(listings),
  skewness(months_inventory)
)

kurtosis_values <- c(
  NA,
  NA,
  NA,
  kurtosis(sales) - 3,
  kurtosis(volume) - 3,
  kurtosis(median_price) - 3,
  kurtosis(listings) - 3,
  kurtosis(months_inventory) - 3
)

# Creazione del dataframe
df <- data.frame(
  Variabile = c("city","year", "month", "sales", "volume", "median_price", "listings", "months_inventory"),
  Asimmetria = skewness_values,
  Curtosi = kurtosis_values
)

print(df)
```

# 4 - Suddivisione in classi della variabile volume e calcolo dell'indice di Gini

```{r, echo=TRUE}
# PRIMA PROPOSTA
# Creazione delle classi di volume in base ai valori caratteristici
dati$volume_class <- cut(volume, breaks = c(8.166, 27.063, 31.005, 85.547)) 
# Frequenze per le classi di volume (per costruzione grafico)
freq_volume <- table(dati$volume_class)

# Creazione del grafico delle frequenze per le classi di volume
ggplot(as.data.frame(freq_volume), aes(x = Var1, y = Freq/length(dati$volume_class))) + # var1 e freq vengono create di default con il dataframe
  geom_col(fill = "steelblue") +
  labs(title = "Distribuzione di frequenza per classi di 'volume'",
       x = "Classi di volume", y = "Frequenza") +
  theme_minimal()
```
```{r, echo=TRUE}
# Calcolo dell'indice di Gini per la distribuzione di frequenza delle classi di volume
gini_volume <- gini.index(dati$volume_class) # Osservazione: se si passa freq_volume allora viene applicato 2 volte table (1 tramite funzione e 1 per def di freq_volume)
gini_volume
```
```{r, echo=TRUE}
# SECONDA PROPOSTA
dati$volume_class <- cut(volume, breaks = c(seq(1,100,6))) # Suddivisione del supporto in sottointervalli

freq_volume <- table(dati$volume_class)

ggplot(as.data.frame(freq_volume), aes(x = Var1, y = Freq/length(dati$volume_class))) +
  geom_col(fill = "steelblue") +
  labs(title = "Distribuzione di frequenza per classi di 'volume'",
       x = "Classi di volume", y = "Frequenza") +
  theme_minimal()
```
```{r, echo=TRUE}
gini_volume <- gini.index(dati$volume_class)
gini_volume
```


```{r, echo=TRUE}
hist(volume, probability = TRUE, main = "Istogramma con Densità Kernel", xlab = "Volume", col = "lightblue", border = "black")
lines(density(volume), col = "red", lwd = 2)
# La distribuzione è asimmetrica positiva (come ci si aspettava)
```

# 5 - Calcolo dell'indice di Gini per la variabile city


```{r, echo=TRUE}
# Dimostrazione
gini_city <- gini.index(city)
gini_city
```

# 6 - Calcolo delle probabilità

```{r, echo=TRUE}
totale <- nrow(dati)
prob_beaumont <- sum(city == "Beaumont") / totale
prob_luglio <- sum(month == "7") / totale
prob_dec2012 <- sum(month == "12" & year == 2012) / totale

print(paste("Probabilità di una osservazione casuale con città Beaumont: ", prob_beaumont))
print(paste("Probabilità di una osservazione casuale con mese Luglio: ", round(prob_luglio,3)))
print(paste("Probabilità di una osservazione casuale con mese Dicembre e anno 2012: ", round(prob_dec2012,3))) # 1,67%
```

# 7 - Creazione di una colonna che rappresenti il prezzo medio

```{r, echo=TRUE}
dati$mean_price <- (dati$volume * 1e6) / dati$sales # moltiplicazione per un milione dato che nel dataset è scalata e l'ordine di grandezza si riduce dividendo per sales
head(dati[c("volume", "sales", "mean_price")])
```

# 8 - Creazione di una colonna che rappresenti l'efficacia

```{r, echo=TRUE}
dati$efficacia <- dati$sales / dati$listings
head(dati[, c("sales", "listings", "efficacia")])
```

# 9 - Analisi condizionata

```{r, echo=TRUE}
# Condizionamento a city
sintesi <- dati %>%
  group_by(city) %>%
  summarise(
    media_sales = mean(sales),
    sd_sales = sd(sales),
    media_volume = mean(volume),
    sd_volume = sd(volume),
    media_listings = mean(listings),
    sd_listings = sd(listings)
  )
sintesi
```
```{r, echo=TRUE}
g1<-ggplot(sintesi, aes(x = city, y = media_sales, fill = city)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = media_sales - sd_sales, ymax = media_sales + sd_sales), # bande di errore con ds
                position = position_dodge(width = 0.9), width = 0.25) +
  labs(title = "Media numero vendite (sales) per città con Deviazione Standard", 
       x = "City", y = "Sales") +
  theme_minimal()+
  theme(legend.position = "none")

g2<-ggplot(sintesi, aes(x = city, y = media_volume, fill = city)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = media_volume - sd_volume, ymax = media_volume + sd_volume), 
                position = position_dodge(width = 0.9), width = 0.25) +
  labs(title = "Media valore delle vendite (volume) per città con Deviazione Standard", 
       x = "City", y = "Volume") +
  theme_minimal()+
  theme(legend.position = "none")

g3<-ggplot(sintesi, aes(x = city, y = media_listings, fill = city)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = media_listings - sd_listings, ymax = media_listings + sd_listings), 
                position = position_dodge(width = 0.9), width = 0.25) +
  labs(title = "Media annunci attivi (listings) per città con Deviazione Standard", 
       x = "City", y = "Listings") +
  theme_minimal()+
  theme(legend.position = "none")

grid.arrange(g1, g2, g3, ncol = 1) # Output grafico combinato
```

```{r, echo=TRUE}
# Condizionamento a year
sintesi2 <- dati %>%
  group_by(year) %>%
  summarise(
    media_sales = mean(sales),
    sd_sales = sd(sales),
    media_volume = mean(volume),
    sd_volume = sd(volume),
    media_listings = mean(listings),
    sd_listings = sd(listings)
  )
sintesi2
```
```{r, echo=TRUE}
colori <- c("2010" = "#F0F022", "2011" = "#66FF66", "2012" = "#6666FF", "2013" = "#C433FF", "2014" = "#33C4FF")
g1<-ggplot(sintesi2, aes(x = year, y = media_sales, fill = as.factor(year))) + # esplicito as.factor perchè altrimenti i colori seguono una gradazione che non è visivamente ottimale
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = media_sales - sd_sales, ymax = media_sales + sd_sales), 
                position = position_dodge(width = 0.9), width = 0.25) +
  scale_fill_manual(values = colori) +
  labs(title = "Media numero vendite (sales) per anno con Deviazione Standard", 
       x = "Year", y = "Sales") +
  theme_minimal()+
  theme(legend.position = "none")

g2<-ggplot(sintesi2, aes(x = year, y = media_volume, fill = as.factor(year))) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = media_volume - sd_volume, ymax = media_volume + sd_volume), 
                position = position_dodge(width = 0.9), width = 0.25) +
  scale_fill_manual(values = colori) +
  labs(title = "Media valore delle vendite (volume) per anno con Deviazione Standard", 
       x = "Year", y = "Volume") +
  theme_minimal()+
  theme(legend.position = "none")

g3<-ggplot(sintesi2, aes(x = year, y = media_listings, fill = as.factor(year))) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = media_listings - sd_listings, ymax = media_listings + sd_listings), 
                position = position_dodge(width = 0.9), width = 0.25) +
  scale_fill_manual(values = colori) +
  labs(title = "Media annunci attivi (listings) per anno con Deviazione Standard", 
       x = "Year", y = "Listings") +
  theme_minimal()+
  theme(legend.position = "none")

grid.arrange(g1, g2, g3, ncol = 1)
```

```{r, echo=TRUE}
# Condizionamento a month
sintesi3 <- dati %>%
  group_by(month) %>%
  summarise(
    media_sales = mean(sales),
    sd_sales = sd(sales),
    media_volume = mean(volume),
    sd_volume = sd(volume),
    media_listings = mean(listings),
    sd_listings = sd(listings)
  )
head(sintesi3,12)
```
```{r, echo=TRUE}
colori <- c(
  "1" = "red",   
  "2" = "#4682B4",   
  "3" = "#32CD32",  
  "4" = "#FFD700",  
  "5" = "#8A2BE2",  
  "6" = "#FF1493",  
  "7" = "#00FFFF",   
  "8" = "grey",   
  "9" = "#800080",   
  "10" = "#00FF00",  
  "11" = "orange",  
  "12" = "#0000FF"
)
g1<-ggplot(sintesi3, aes(x = month, y = media_sales, fill = as.factor(month))) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = media_sales - sd_sales, ymax = media_sales + sd_sales), 
                position = position_dodge(width = 0.9), width = 0.25) +
  scale_fill_manual(values = colori) +
  labs(title = "Media numero vendite (sales) per mese con Deviazione Standard", 
       x = "Month", y = "Sales") +
  scale_x_continuous(breaks = 1:12) +
  theme_minimal()+
  theme(legend.position = "none")

g2<-ggplot(sintesi3, aes(x = month, y = media_volume, fill = as.factor(month))) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = media_volume - sd_volume, ymax = media_volume + sd_volume), 
                position = position_dodge(width = 0.9), width = 0.25) +
  scale_fill_manual(values = colori) +
  labs(title = "Media valore delle vendite (volume) per mese con Deviazione Standard", 
       x = "Month", y = "Volume") +
  scale_x_continuous(breaks = 1:12) +
  theme_minimal()+
  theme(legend.position = "none")

g3<-ggplot(sintesi3, aes(x = month, y = media_listings, fill = as.factor(month))) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = media_listings - sd_listings, ymax = media_listings + sd_listings), 
                position = position_dodge(width = 0.9), width = 0.25) +
  scale_fill_manual(values = colori) +
  labs(title = "Media annunci attivi (listings) per mese con Deviazione Standard", 
       x = "Month", y = "Listings") +
  scale_x_continuous(breaks = 1:12) +
  theme_minimal()+
theme(legend.position = "none")

grid.arrange(g1, g2, g3, ncol = 1)
```

# 10 - Grafici con ggplot2

### 10.1 - Boxplots

```{r, echo=TRUE}
# Boxplot del prezzo mediano per città
dati$city <- as.factor(dati$city)
ggplot(dati, aes(x = city, y = median_price)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") +
  labs(title = "Boxplot del prezzo mediano per città",
       x = "Città", y = "Prezzo Mediano") +
  theme_minimal()
```

```{r, echo=TRUE}
# Boxplot sales per città affiancato nei diversi anni
ggplot(dati, aes(x = city, y = sales, fill = as.factor(year))) +
  geom_boxplot() +
  labs(title = "Boxplot del numero di vendite per città e anno",
       x = "Città", y = "Numero di vendite") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3", name = "Anno")
```

### 10.2 - Grafici a barre sovrapposte

```{r, echo=TRUE}
# Grafico a barre sovrapposte per il totale delle vendite nei vari mesi e città
vendite_mensili <- dati %>%
  group_by(month, city, year) %>%
  summarise(tot_sales = sum(sales)) %>%
  ungroup() 

colori_citta <- c(
  "Beaumont" = "#1b9e77",
  "Bryan-College Station" = "#d95f02",
  "Tyler" = "#7570b3",
  "Wichita Falls" = "#e7298a"
)

g1<-ggplot(vendite_mensili, aes(x = month, y = tot_sales, fill = city)) +
  geom_col(position = "stack") +
  scale_fill_manual(values = colori_citta) +
  scale_x_continuous(breaks = 1:12) +
  labs(title = "Vendite mensili per città",
       x = "Mese", y = "Totale vendite") +
  theme_minimal()

g2<-ggplot(vendite_mensili, aes(x = month, y = tot_sales, fill = city)) +
  geom_col(position = "fill") + # grafico normalizzato
  scale_fill_manual(values = colori_citta) +
  scale_x_continuous(breaks = 1:12) +
  labs(title = "Vendite mensili normalizzate per città",
       x = "Mese", y = "Proporzione vendite") +
  theme_minimal()

grid.arrange(g1, g2, ncol = 1)
```

```{r, echo=TRUE}
# Grafico a barre sovrapposte per vendite mensili per città, con differenziazione per anno
colori_citta <- c(
  "Beaumont" = "#1b9e77",
  "Bryan-College Station" = "#d95f02",
  "Tyler" = "#7570b3",
  "Wichita Falls" = "#e7298a"
)

g1 <- ggplot(vendite_mensili, aes(x = month, y = tot_sales, fill = city)) +
  geom_col(position = "stack") +
  scale_fill_manual(values = colori_citta) +
  scale_x_continuous(breaks = 1:12) +
  labs(
    title = "Vendite mensili per città e anni",
    x = "Mese",
    y = "Totale vendite",
    fill = "Città"
  ) +
  theme_minimal() +
  facet_wrap(~ as.factor(year))
g1

```

```{r, echo=TRUE}
# grafico sales-month-city-year normalizzato
g2 <- ggplot(vendite_mensili, aes(x = month, y = tot_sales, fill = city)) +
  geom_col(position = "fill") +
  scale_fill_manual(values = colori_citta) +
  scale_x_continuous(breaks = 1:12) +
  labs(
    title = "Vendite mensili per città e anni",
    x = "Mese",
    y = "Totale vendite",
    fill = "Città"
  ) +
  theme_minimal() +
  facet_wrap(~ as.factor(year))
g2
```

## 10.3 - Line chart

```{r, echo=TRUE}
dati$data <- as.Date(paste(dati$year, sprintf("%02d", dati$month), "01", sep = "-"))

# Creazione del grafici
g1<-ggplot(dati, aes(x = data, y = sales, color = city)) +
  geom_line() +
  scale_x_date(date_breaks = "1 year", date_labels = "1/1/%Y")+
  labs(title = "Andamento delle vendite nel tempo per città (line chart)",
       x = "Data", y = "Numero di vendite") +
  theme_minimal()

g2<-ggplot(dati, aes(x = data, y = sales, color = city)) +
  geom_jitter() + # risalto dei punti
  geom_line() +
  scale_x_date(date_breaks = "1 year", date_labels = "1/1/%Y")+
  labs(title = "Andamento delle vendite nel tempo per città",
       x = "Data", y = "Numero di vendite") +
  theme_minimal()

grid.arrange(g1, g2, ncol = 1)
```



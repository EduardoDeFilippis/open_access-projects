# 0 - Preparazione dell'ambiente di lavoro
```{r, echo=TRUE, results='hide'}
options(repos = c(CRAN = "https://cran.rstudio.com/")) #per creazione del documento con knit
library(ggplot2)   
library(carData)
library(car)         #per diagnostica del modello
library(moments)       #per calcolo di asimmetria e curtosi
library(gridExtra)    #per personalizzazione della finestra output
library(knitr)    #per formattare meglio alcune tabelle
library(kableExtra)      #per formattare meglio alcune tabelle
```

# 1 - Preparazione dei dati

```{r, echo=TRUE}
neonati <- read.csv("neonati.csv", header = TRUE, stringsAsFactors = FALSE) #import dati
```

```{r, echo=TRUE}
#codifica e conversione variabili
neonati$Fumatrici <- factor(neonati$Fumatrici) #già codificata

neonati$Tipo.parto[neonati$Tipo.parto == "Nat"] <- "0"
neonati$Tipo.parto[neonati$Tipo.parto == "Ces"] <- "1"
neonati$Tipo.parto <- factor(neonati$Tipo.parto)

neonati$Ospedale[neonati$Ospedale == "osp1"] <- "1"
neonati$Ospedale[neonati$Ospedale == "osp2"] <- "2"
neonati$Ospedale[neonati$Ospedale == "osp3"] <- "3"
neonati$Ospedale <- factor(neonati$Ospedale)

neonati$Sesso[neonati$Sesso == "M"] <- "0"
neonati$Sesso[neonati$Sesso == "F"] <- "1"
neonati$Sesso <- factor(neonati$Sesso)

attach(neonati) #estrazione colonne
```

```{r, echo=TRUE}
#visualizzazione prime 10 righe
kable(head(neonati,10), align = rep('c', 10)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

```{r, echo=TRUE}
str(neonati) #struttura generale
```

```{r, echo=TRUE}
kable(neonati[1,], align = rep('c', 10)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

# 2 - Analisi esplorativa e descrittiva

## 2.1 - Statistiche descrittive generali
```{r, echo=TRUE}
options(knitr.kable.NA = "") #celle vuote
kable(summary(neonati), align = rep('c', 10)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```


```{r, echo=TRUE}
tmp<-sort(neonati$Anni.madre)
print(head(tmp, 20))
```

```{r, echo=TRUE}
tmp<-tmp[3:length(tmp)]
mean(tmp)
```

```{r, echo=TRUE}
neonati[neonati$Anni.madre %in% c(0, 1), ]

#imputazione con media nel dataset
neonati$Anni.madre[1380]=28.18615
neonati$Anni.madre[1152]=28.18615
```

```{r, echo=TRUE}
kable(summary(neonati), align = rep('c', 10)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

```{r, echo=TRUE}
freq_ass <- table(Fumatrici)
freq_rel <- table(Fumatrici)/length(Fumatrici) # Tabella distribuzione frequenze relative
distr_freq_Fumatrici<-data.frame(cbind(freq_ass,freq_rel)) 
distr_freq_Fumatrici
```


```{r, echo=TRUE}
freq_ass <- table(Tipo.parto)
freq_rel <- table(Tipo.parto)/length(Tipo.parto)
distr_freq_Tipo.parto<-data.frame(cbind(freq_ass,freq_rel)) 
distr_freq_Tipo.parto
```


```{r, echo=TRUE}
freq_ass <- table(Ospedale)
freq_rel <- table(Ospedale)/length(Ospedale)
distr_freq_Ospedale<-data.frame(cbind(freq_ass,freq_rel)) 
distr_freq_Ospedale
```


```{r, echo=TRUE}
freq_ass <- table(Sesso)
freq_rel <- table(Sesso)/length(Sesso)
distr_freq_Sesso<-data.frame(cbind(freq_ass,freq_rel)) 
distr_freq_Sesso
```

```{r, echo=TRUE}
# La variabile numero gravidanze (quantitativa discreta) presenta poche modalità quindi per fini di esplorazione si stampano le frequenze
freq_ass <- table(N.gravidanze)
freq_rel <- table(N.gravidanze)/length(N.gravidanze)
distr_freq_ng<-data.frame(cbind(freq_ass,freq_rel)) 
kable(distr_freq_ng, align = rep('c', 3)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

## 2.2 - Distribuzioni empiriche, stime del kernel e indici di asimmetria e curtosi
```{r, echo=TRUE}
# Distribuzione Anni della madre
g1<-ggplot(neonati, aes(x = Anni.madre)) +
  geom_histogram(aes(y = after_stat(density)), binwidth = 1, fill = "steelblue", color = "black") +
  geom_density(color = "red", size = 0.7) +
  labs(x = "Anni.madre", y = "Frequenza")

# Distribuzione del Numero di gravidanze associato alla madre
g2<-ggplot(neonati, aes(x = N.gravidanze)) +
  geom_histogram(aes(y = after_stat(count / sum(count))), binwidth = 0.3, fill = "steelblue", color = "black") +
  labs(x = "N.gravidanzee", y = "Frequenza")

# Distribuzione delle settimane di gestazione
g3<-ggplot(neonati, aes(x = Gestazione)) +
  geom_histogram(aes(y = after_stat(count / sum(count))), binwidth = 0.3, fill = "steelblue", color = "black") +
  labs(x = "Gestazione", y = "Frequenza")

#Distribuzione del Peso del neonato (variabile risposta)
g4<-ggplot(neonati, aes(x = Peso)) +
  geom_histogram(aes(y = after_stat(density)), binwidth = 70, fill = "steelblue", color = "black") +
  geom_density(color = "red", size = 0.7) +
  labs(x = "Peso", y = "Frequenza")

#Distribuzione della lunghezza del neonato
g5<-ggplot(neonati, aes(x = Lunghezza)) +
  geom_histogram(aes(y = after_stat(density)), binwidth = 10, fill = "steelblue", color = "black") +
  geom_density(color = "red", size = 0.7) +
  labs(x = "Lunghezza", y = "Frequenza")

# Distribuzione della grandezza del cranio del neonato
g6<-ggplot(neonati, aes(x = Cranio)) +
  geom_histogram(aes(y = after_stat(density)), binwidth = 5, fill = "steelblue", color = "black") +
  geom_density(color = "red", size = 0.7) +
  labs(x = "Cranio", y = "Frequenza")

grid.arrange(g1, g2, g3, g4, g5, g6, ncol = 3)
```

```{r, echo=TRUE}
skewness_values <- c(
  skewness(Anni.madre),
  skewness(N.gravidanze),
  NA,# non ha senso calcolare questi indicatori su variabili come fumatrici, tipo parto, ospedale e sesso
  skewness(Gestazione),
  skewness(Peso),
  skewness(Lunghezza),
  skewness(Cranio),
  NA,
  NA,
  NA
)

kurtosis_values <- c(
  kurtosis(Anni.madre)-3,
  kurtosis(N.gravidanze)-3,
  NA,
  kurtosis(Gestazione)-3,
  kurtosis(Peso)-3,
  kurtosis(Lunghezza)-3,
  kurtosis(Cranio)-3,
  NA,
  NA,
  NA
)

# Creazione del dataframe
df <- data.frame(
  Variabile = c("Anni.madre","N.gravidanze", "Fumatrici", "Gestazione", "Peso", "Lunghezza", "Cranio", "Tipo.parto", "Ospedale", "Sesso"),
  Asimmetria = skewness_values,
  Curtosi = kurtosis_values
)

kable(df, align = rep('c', 3)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

## 2.3 - Boxplots
```{r, echo=TRUE}
p1 <- ggplot(neonati, aes(y = Anni.madre)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") +
  labs(title = "Anni.madre", y = "Anni") +
  theme_minimal()

p2 <- ggplot(neonati, aes(y = N.gravidanze)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") +
  labs(title = "N.gravidanze", y = "Numero") +
  theme_minimal()

p3 <- ggplot(neonati, aes(y = Gestazione)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") +
  labs(title = "Gestazione", y = "Settimane") +
  theme_minimal()

p4 <- ggplot(neonati, aes(y = Peso)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") +
  labs(title = "Peso", y = "Peso (grammi)") +
  theme_minimal()

p5 <- ggplot(neonati, aes(y = Lunghezza)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") +
  labs(title = "Lunghezza", y = "Lunghezza (cm)") +
  theme_minimal()

p6 <- ggplot(neonati, aes(y = Cranio)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") +
  labs(title = "Cranio", y = "Circonferenza (cm)") +
  theme_minimal()

#boxplots relativi a Fumatrici, Tipo.parto, Ospedale e Sesso sono omessi poichè variabili binarie o con tre modalità (Ospedale)

grid.arrange(p1, p2, p3, p4, p5, p6, ncol = 3)
```

## 2.4 - Boxplot del Peso in base ad alcune features
```{r, echo=TRUE}
h1<-ggplot(neonati, aes(x = Fumatrici, y = Peso, fill = Fumatrici)) +
  geom_boxplot() +
  labs(title = "Peso|Fumatrice", x = "fumatrici", y = "Peso (grammi)")

h2<-ggplot(neonati, aes(x = Tipo.parto, y = Peso, fill = Tipo.parto)) +
  geom_boxplot() +
  labs(title = "Peso|Tipo.parto", x = "tipo parto", y = "Peso (grammi)")

h3<-ggplot(neonati, aes(x = Ospedale, y = Peso, fill = Ospedale)) +
  geom_boxplot() +
  labs(title = "Peso|Ospedale", x = "ospedale", y = "Peso (grammi)")

h4<-ggplot(neonati, aes(x = Sesso, y = Peso, fill = Sesso)) +
  geom_boxplot() +
  labs(title = "Peso|Sesso", x = "Sesso", y = "Peso (grammi)")

grid.arrange(h1, h2, h3, h4, ncol = 2)
```

# 3 - Verifica delle ipotesi

## 3.1 - Ipotesi: In alcuni ospedali si fanno più parti cesarei

```{r, echo=TRUE}
# Tabella di contingenza per Ospedale e Tipo di Parto
tab_parto <- table(Ospedale, Tipo.parto)
print(tab_parto)
# Test chi-quadro per verificare l'associazione tra variabili categoriali (in distribuzioni doppie)
test_parto <- chisq.test(tab_parto)
print(test_parto)
```

## 3.2 - Ipotesi: La media del peso e della lunghezza sono significativamente uguali a quelle della popolazione

```{r, echo=TRUE}
# Definiamo dei valori ipotetici di riferimento:
pop_mean_peso <- 3250      # Secondo la letteratura, il peso della popolazione di riferimento (neonati) si aggira intorno a 3284 grammi
pop_mean_lunghezza <- 49.5   # Secondo la letteratura, la lunghezza della popolazione di riferimento (neonati) si aggira intorno a 49.5 centimetri
#fonte: https://www.who.int/publications/i/item/924154693X

# Test t a campione singolo per il Peso
t_test_peso <- t.test(Peso, mu = pop_mean_peso)
print(t_test_peso)

# Supponendo che la lunghezza cranio
t_test_lunghezza <- t.test(Lunghezza, mu = pop_mean_lunghezza)
print(t_test_lunghezza)

# Test aggiuntivo peso-----1.1
t_test_lunghezza <- t.test(Peso, mu = pop_mean_peso, alternative = "greater")
print(t_test_lunghezza)

# Test aggiuntivo peso------1.2
t_test_lunghezza <- t.test(Peso, mu = pop_mean_peso, alternative = "less")
print(t_test_lunghezza)

# Test aggiuntivo lunghezza cranio---------2.1
t_test_lunghezza <- t.test(Lunghezza, mu = pop_mean_lunghezza, alternative = "greater")
print(t_test_lunghezza)

# Test aggiuntivo lunghezza cranio-------2.2
t_test_lunghezza <- t.test(Lunghezza, mu = pop_mean_lunghezza, alternative = "less")
print(t_test_lunghezza)

```

## 3.3 - Ipotesi: Le misure antropometriche sono significativamente diverse tra i due sessi

```{r, echo=TRUE}
# Confronto per il Peso
t_test_sex_peso <- t.test(Peso ~ Sesso, data = neonati)
print(t_test_sex_peso)

# Confronto per la Lunghezza
t_test_sex_lunghezza <- t.test(Lunghezza ~ Sesso, data = neonati)
print(t_test_sex_lunghezza)

# Confronto per Cranio
t_test_sex_cranio <- t.test(Cranio ~ Sesso, data = neonati)
print(t_test_sex_cranio)
```

# 4 - Modelli

## 4.1 - Grafici (scatterplot) preliminari alla costruzione modelli regressivi

```{r, echo=TRUE}
w1 <- ggplot(neonati, aes(x = Anni.madre, y = Peso)) +
  geom_point(color = "blue") +
  labs(title = "Scatterplot Anni.madre-Peso", x = "Anni.madre", y = "Peso")

w2 <- ggplot(neonati, aes(x = N.gravidanze, y = Peso)) +
  geom_point(color = "blue") +
  labs(title = "Scatterplot N.gravidanze-Peso", x = "N.gravidanze", y = "Peso")

w3 <- ggplot(neonati, aes(x = Gestazione, y = Peso)) +
  geom_point(color = "blue") +
  labs(title = "Scatterplot Gestazione-Peso", x = "Settimane di gestazione", y = "Peso")

w4 <- ggplot(neonati, aes(x = Lunghezza, y = Peso)) +
  geom_point(color = "blue") +
  labs(title = "Scatterplot Lunghezza-Peso", x = "Lunghezza", y = "Peso")

w5 <- ggplot(neonati, aes(x = Cranio, y = Peso)) +
  geom_point(color = "blue") +
  labs(title = "Scatterplot Cranio-Peso", x = "Grandezza cranio", y = "Peso")

# Disposizione dei grafici in una griglia
grid.arrange(w1, w2, w3, w4, w5, ncol = 3)
```

## 4.2 - Correlazioni

```{r, echo=TRUE}
# grafico matrice di correlazione
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  r <- (cor(x, y))
  txt <- format(c(r, 1), digits = digits)[1]
  txt <- paste0(prefix, txt)
  if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
  text(0.5, 0.5, txt, cex = 1.5)
}
# sotto le correlazioni, sopra i grafici associati

suppressWarnings({ # soppressione "Warning: argument 1 does not name a graphical parameter"
  pairs(neonati, lower.panel = panel.cor, upper.panel = panel.smooth)
})
```

# 4.3 Modelli regressivi

```{r, echo=TRUE}
m0.1 <- lm(Peso ~ Anni.madre)
summary(m0.1)
```

```{r, echo=TRUE}
m0.2 <- lm(Peso ~ I(Anni.madre))
summary(m0.2)
```

```{r, echo=TRUE}
m0.3<- lm(Peso ~ N.gravidanze)
summary(m0.3)
```

```{r, echo=TRUE}
m0.4 <- lm(Peso ~ Fumatrici)
summary(m0.4)
```

```{r, echo=TRUE}
m0.5 <- lm(Peso ~ Gestazione)
summary(m0.5)
```

```{r, echo=TRUE}
m0.6 <- lm(Peso ~ I(Gestazione))
summary(m0.6)
```

```{r, echo=TRUE}
m0.7 <- lm(Peso ~ Lunghezza)
summary(m0.7)
```

```{r, echo=TRUE}
m0.8 <- lm(Peso ~ I(Lunghezza))
summary(m0.8)
```

```{r, echo=TRUE}
m0.9 <- lm(Peso ~ Cranio)
summary(m0.9)
```

```{r, echo=TRUE}
m0.10 <- lm(Peso ~ I(Cranio))
summary(m0.10)
```

```{r, echo=TRUE}
m0.11 <- lm(Peso ~ Sesso)
summary(m0.11)
```


```{r, echo=TRUE}
m1 <- lm(Peso ~ Anni.madre+N.gravidanze+Fumatrici+Gestazione+Lunghezza+Cranio+Sesso)
summary(m1)
```

```{r, echo=TRUE}
m2<- lm(Peso ~ N.gravidanze+Fumatrici+Gestazione+Lunghezza+Cranio+Sesso)
summary(m2)
```

```{r, echo=TRUE}
m3 <- lm(Peso ~ N.gravidanze+Gestazione+Lunghezza+Cranio+Sesso)
summary(m3)
```

```{r, echo=TRUE}
anova(m2,m3)
```

```{r, echo=TRUE}
vif(m3)
```

```{r, echo=TRUE}
#interazioni
m4 <- lm(Peso ~ N.gravidanze+Gestazione+Lunghezza+Cranio+Sesso+Sesso*Fumatrici)
summary(m4)
vif(m4)
```

```{r, echo=TRUE}
m5 <- lm(Peso ~ Gestazione+Cranio+N.gravidanze+Sesso*Fumatrici)
summary(m5)
vif(m5)
```


```{r, echo=TRUE}
kable(cbind(AIC(m1,m2,m3,m4,m5),BIC(m1,m2,m3,m4,m5)), align = rep('c', 5)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```


```{r, echo=TRUE}
r_squared <- summary(m1)$adj.r.squared
rmse <- sqrt(mean(m1$residuals^2))
cbind(paste("m1:::","R² =", r_squared),paste("RMSE =", rmse))

r_squared <- summary(m2)$adj.r.squared
rmse <- sqrt(mean(m2$residuals^2))
cbind(paste("m2:::","R² =", r_squared),paste("RMSE =", rmse))

r_squared <- summary(m3)$adj.r.squared
rmse <- sqrt(mean(m3$residuals^2))
cbind(paste("m3:::","R² =", r_squared),paste("RMSE =", rmse))

r_squared <- summary(m4)$adj.r.squared
rmse <- sqrt(mean(m4$residuals^2))
cbind(paste("m4:::","R² =", r_squared),paste("RMSE =", rmse))

r_squared <- summary(m5)$adj.r.squared
rmse <- sqrt(mean(m5$residuals^2))
cbind(paste("m5:::","R² =", r_squared),paste("RMSE =", rmse))
#il migliore è m3 secondo r2adj, rmse aic, bic e vif
```

# 5 - Analisi dei residui e diagnostica del modello m3


```{r, echo=TRUE}
# Creazione dell'istogramma con 80 barre e scala di densità
hist(residuals(m3), breaks = 80, freq = FALSE, 
     main = "Istogramma dei residui con stima kernel",
     xlab = "Residui", col = "lightgray", border = "white")

# Sovrapposizione della curva di densità kernel
lines(density(residuals(m3)), col = "red", lwd = 1)
```


```{r, echo=TRUE}
# Plot diagnostici
par(mfrow=c(2,2))
plot(m3)
par(mfrow=c(1,1)) # reset finestra
```

  
```{r, echo=TRUE}
shapiro.test(m3$residuals)
lmtest::bptest(m3)
lmtest::dwtest(m3)
```


```{r, echo=TRUE}                                                                                                                               
# leverage
lev<-hatvalues(m3)
plot(lev)
p<-sum(lev)
n<-length(lev)
soglia=2*p/n
abline(h=soglia,col=2)
```

```{r, echo=TRUE}
lev[lev>soglia]
```

```{r, echo=TRUE}
lev[lev>0.04]
```


```{r, echo=TRUE}
# outliers
plot(rstudent(m3))
abline(h=c(-2,2))
```

```{r, echo=TRUE}
car::outlierTest(m3)
```


```{r, echo=TRUE}
# distanza di cook
cook<-cooks.distance(m3)
plot(cook,ylim = c(0,0.9)) 
```

```{r, echo=TRUE}
max(cook)
```

```{r, echo=TRUE}
# cook     ----output omesso poichè troppo lungo
```

```{r, echo=TRUE}
unname(which.max(cook)) #indice osservazione
```

# 6 - Previsione

```{r, echo=TRUE}
# con valori medi per le altre variabili (modifica in base alla distribuzione dei dati).
nuovo_caso <- data.frame(
  N.gravidanze = 3,
  Gestazione = 39,
  Lunghezza = mean(Lunghezza),
  Cranio = mean(Cranio), 
  Sesso = as.factor(1)
)
predizione <- predict(m3, newdata = nuovo_caso, interval = "prediction")
print("Previsione modello 3: ")
print(predizione)
```


```{r, echo=TRUE}
# Grafico 1: Peso vs Numero di Gravidanze
f1 <- ggplot(neonati, aes(x = N.gravidanze, y = Peso)) +
  geom_point(aes(color = Sesso), alpha = 0.3) +
  geom_smooth(aes(group = Sesso), method = "lm", formula = y ~ x, se = FALSE, color = "black", size = 1) +
  geom_smooth(aes(color = Sesso), method = "lm", formula = y ~ x, se = FALSE, size = 0.5) +
  labs(
       x = "N.gravidanze",
       y = "Peso")

# Grafico 2: Peso vs Settimane di Gestazione
f2 <- ggplot(neonati, aes(x = Gestazione, y = Peso)) +
  geom_point(aes(color = Sesso), alpha = 0.3) +
  geom_smooth(aes(group = Sesso), method = "lm", formula = y ~ x, se = FALSE, color = "black", size = 1) +
  geom_smooth(aes(color = Sesso), method = "lm", formula = y ~ x, se = FALSE, size = 0.5) +
  labs(
       x = "Gestazione",
       y = "Peso")

# Grafico 3: Peso vs Lunghezza
f3 <- ggplot(neonati, aes(x = Lunghezza, y = Peso)) +
  geom_point(aes(color = Sesso), alpha = 0.3) +
  geom_smooth(aes(group = Sesso), method = "lm", formula = y ~ x, se = FALSE, color = "black", size = 1) +
  geom_smooth(aes(color = Sesso), method = "lm", formula = y ~ x, se = FALSE, size = 0.5) +
  labs(
       x = "Lunghezza",
       y = "Peso")

# Grafico 4: Peso vs Circonferenza Cranica
f4 <- ggplot(neonati, aes(x = Cranio, y = Peso)) +
  geom_point(aes(color = Sesso), alpha = 0.3) +
  geom_smooth(aes(group = Sesso), method = "lm", formula = y ~ x, se = FALSE, color = "black", size = 1) +
  geom_smooth(aes(color = Sesso), method = "lm", formula = y ~ x, se = FALSE, size = 0.5) +
  labs(
       x = "Cranio",
       y = "Peso")

# Disposizione dei grafici in una griglia
grid.arrange(f1, f2, f3, f4, ncol = 2)
```



```{r, echo=TRUE}
# Caricamento del pacchetto ggeffects
library(ggeffects)
```

```{r, echo=TRUE}
# Ottenere le previsioni marginali con interazione tra la variabile di interesse e Sesso
effetti_ngravidanze <- ggpredict(m3, terms = c("N.gravidanze", "Sesso"))
effetti_gestazione  <- ggpredict(m3, terms = c("Gestazione", "Sesso"))
effetti_cranio      <- ggpredict(m3, terms = c("Cranio", "Sesso"))
effetti_lunghezza   <- ggpredict(m3, terms = c("Lunghezza", "Sesso"))

# Visualizzare le previsioni con le osservazioni originali
b1 <- plot(effetti_ngravidanze, show_data = TRUE)+ labs(title = NULL)
b2 <- plot(effetti_gestazione,  show_data = TRUE)+ labs(title = NULL)
b3 <- plot(effetti_lunghezza,   show_data = TRUE)+ labs(title = NULL)
b4 <- plot(effetti_cranio,      show_data = TRUE)+ labs(title = NULL)

# Disposizione dei grafici in una griglia
grid.arrange(b1, b2, b3, b4, ncol = 2)
```


